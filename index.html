<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enregistrement - Air Arlette</title>
<style>
:root{
  --primary:#408ABA;
  --secondary:#00ADEF;
  --bg:#F5F5F5;
  --text:#333;
  --btn:#FF4136;
  --btn-hover:#e03e2d;
}

body{
  margin:0; 
  font-family:Arial, sans-serif;
  background:var(--bg);
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  min-height:100vh;
}

/* HEADER */
header{
  width:100%;
  background:var(--primary);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 24px;
  padding-left:34px;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  color:#fff;
}

header img{
  height:50px;
  margin-left:10px;
  object-fit:contain;
}

.header-right{
  display:flex;
  align-items:center;
  gap:16px;
  font-size:0.95rem;
  font-weight:600;
}

.lang-flag{
  display:flex; 
  align-items:center; 
  gap:4px;
}

.lang-flag img{
  height:16px;
  width:24px;
  object-fit:cover;
  border-radius:2px;
}

.icon-conn{
  display:flex; 
  align-items:center; 
  gap:4px;
}

/* MAIN FORM */
main{
  flex:1; 
  display:flex; 
  align-items:center; 
  justify-content:center;
  width:100%; 
  padding:24px;
}

form.boarding-pass{
  background:#fff; 
  border-radius:16px; 
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
  width:100%; 
  max-width:800px; 
  padding:32px;
  position:relative;
  border-top:6px solid var(--secondary);
}

form h1{
  text-align:center; 
  color:var(--primary); 
  margin-bottom:24px;
  font-size:1.5rem; 
  letter-spacing:1px;
}

label{ 
  display:block; 
  margin-top:16px; 
  font-weight:600; 
  color:var(--text); 
}

/* Flex deux colonnes avec séparation */
.form-columns{
  display:flex;
  gap:16px; 
  flex-wrap:wrap;
  position:relative;
}

.form-left, .form-right{
  flex:1 1 250px; 
  display:flex;
  flex-direction:column;
}

.form-left{
  padding-right:16px;
  position:relative; 
}

/* Ligne de séparation avec motif et ombre */
.form-left::after{
  content:"";
  position:absolute;
  top:0;
  right:0;
  width:2px;
  height:100%;
  background: linear-gradient(to bottom, #D4D4D4 20%, rgba(212,212,212,0) 20%, rgba(212,212,212,0) 40%, #D4D4D4 40%, #D4D4D4 60%, rgba(212,212,212,0) 60%, rgba(212,212,212,0) 80%, #D4D4D4 80%);
  background-size: 100% 40px;
  box-shadow: 1px 0 4px rgba(0,0,0,0.1);
}

.form-right{
  padding-left:16px;
}

/* Inputs et boutons */
input, select, button{
  width:100%; 
  padding:14px; 
  margin-top:8px;
  border-radius:6px; 
  border:1px solid #ccc; 
  font-size:1rem;
  box-sizing:border-box;
}

input:focus, select:focus{
  outline:none; 
  border-color:var(--primary); 
  box-shadow:0 0 5px rgba(0,116,217,0.5);
}

button{
  background:var(--btn); 
  color:#fff; 
  border:none; 
  cursor:pointer; 
  font-weight:600; 
  margin-top:24px;
  transition:0.3s; 
  font-size:1.1rem;
}

button:hover{ 
  background:var(--btn-hover); 
}

button[disabled]{ 
  opacity:.65; 
  cursor:not-allowed; 
}

#result{ 
  margin-top:16px; 
  text-align:center; 
  font-weight:600; 
}

.confetti{
  position:absolute; 
  top:-10px; 
  width:8px; 
  height:8px; 
  border-radius:50%;
  opacity:.85; 
  pointer-events:none; 
  will-change: transform, opacity;
  transform: translate3d(0,0,0);
  animation:fall linear forwards;
}

@keyframes fall{ 
  to{ transform: translate3d(var(--dx,0),100vh,0) rotate(360deg); opacity:0; } 
}

.hp-field{ 
  position:absolute; 
  left:-10000px; 
  top:auto; 
  width:1px; 
  height:1px; 
  overflow:hidden; 
}

.spinner{ 
  width:16px; 
  height:16px; 
  border:2px solid currentColor; 
  border-right-color:transparent; 
  border-radius:50%; 
  animation:spin .7s linear infinite; 
}

/* Labels de droite en style "carte" */
.readonly-field{
  padding:14px;
  border-radius:8px;
  background:#f9f9f9;
  color:#333;
  margin-top:8px;
  font-size:1rem;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
}

/* RESPONSIVE */
@media(max-width:640px){
  .form-columns{
    flex-direction:column; 
    gap:8px;
  }
  .form-left::after{
    top:auto;
    bottom:0;
    left:0;
    right:0;
    width:100%;
    height:2px;
    background: linear-gradient(to right, #D4D4D4 20%, rgba(212,212,212,0) 20%, rgba(212,212,212,0) 40%, #D4D4D4 40%, #D4D4D4 60%, rgba(212,212,212,0) 60%, rgba(212,212,212,0) 80%, #D4D4D4 80%);
    background-size: 40px 100%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
}
</style>
</head>
<body>

<header>
  <img src="Logo/AirArletteBleu.png" alt="Logo Air Arlette">
  <div class="header-right">
    <div class="lang-flag">
      <img src="https://upload.wikimedia.org/wikipedia/en/c/c3/Flag_of_France.svg" alt="France">
      <span>France – FR</span>
    </div>
    <div class="icon-conn">
      <span>👤</span> <span>Se connecter</span>
    </div>
  </div>
</header>

<main>
  <form id="invitationForm" class="boarding-pass" novalidate>
    <div class="hp-field">
      <label for="hp">Ne pas remplir</label>
      <input type="text" id="hp" name="hp" tabindex="-1" autocomplete="off" />
    </div>

    <h1>Enregistrement à la fête</h1>

    <div class="form-columns">
      <!-- Colonne gauche -->
      <div class="form-left">
        <label for="prenom">Prénom</label>
        <input type="text" id="prenom" name="prenom" placeholder="Prénom" required />

        <label for="nom">Nom</label>
        <input type="text" id="nom" name="nom" placeholder="Nom" required />

        <label for="email">Adresse mail</label>
        <input type="email" id="email" name="email" placeholder="Adresse mail" required />

        <label for="participation">Participez-vous ?</label>
        <select id="participation" name="participation" required>
          <option value="">-- Choisir --</option>
          <option value="oui">Oui</option>
          <option value="non">Non</option>
        </select>

        <label for="nb_personnes">Nombre de personnes</label>
        <input type="number" id="nb_personnes" name="nb_personnes" min="1" value="1" required />
      </div>

      <!-- Colonne droite -->
      <div class="form-right">
        <label>Compagnie</label>
        <p class="readonly-field">Air Arlette</p>

        <label>Numéro de vol</label>
        <p class="readonly-field">AA1234</p>

        <label>Destination</label>
        <p class="readonly-field">Paris</p>

        <label>Heure de l'embarquement</label>
        <p class="readonly-field">14:30</p>
      </div>
    </div>

    <button type="submit" id="submitBtn"><span>Envoyer</span></button>
    <div id="loader" style="display:none; text-align:center; margin-top:8px;">
      <span class="spinner"></span> Envoi…
    </div>
  </form>
</main>

<p id="result" role="status" aria-live="polite"></p>

<script>
// ==== CONFIG ====
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwQZAC1BrnLyndTvt1AlSERvATWI5hYwW4dFZAzfx2O39A8yrKWKRy06Qi5EUSrYf3R4Q/exec";
const LOCK_AFTER_SUCCESS = true;
const ANTISPAM_DELAY = 30;

const form = document.getElementById("invitationForm");
const result = document.getElementById("result");
const loader = document.getElementById("loader");
const submitBtn = document.getElementById("submitBtn");
const fields = ["prenom","nom","email","participation","nb_personnes"];

fields.forEach(id=>{
  const el=document.getElementById(id);
  const saved=localStorage.getItem(id);
  if(el && saved) el.value=saved;
  if(!el) return;
  el.addEventListener("input",e=>localStorage.setItem(id,e.target.value));
});

function launchConfetti(count=40){
  for(let i=0;i<count;i++){
    const c=document.createElement("div");
    c.className="confetti";
    const hue=Math.floor(Math.random()*360);
    const size=6+Math.random()*10;
    const left=Math.random()*100;
    const dx=(Math.random()*200-100)+"px";
    const dur=(2+Math.random()*2).toFixed(2)+"s";
    c.style.backgroundColor=`hsl(${hue} 90% 55%)`;
    c.style.left=left+"vw";
    c.style.width=c.style.height=size+"px";
    c.style.setProperty("--dx",dx);
    c.style.animationDuration=dur;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),parseFloat(dur)*1000);
  }
}

function showMessage(msg,cls){
  result.textContent=msg;
  result.classList.remove("ok","warn","err","show");
  if(cls) result.classList.add(cls);
  result.style.animation="none";
  void result.offsetHeight;
  if(cls==="err") result.style.animation="shake .35s";
  result.classList.add("show");
}

function setLoading(loading){
  if(loading){
    loader.style.display="block";
    submitBtn.disabled=true;
    submitBtn.innerHTML=`<span class="spinner" aria-hidden="true" style="border:2px solid #fff;border-right-color:transparent"></span><span>Envoi…</span>`;
  } else {
    loader.style.display="none";
    submitBtn.disabled=false;
    submitBtn.innerHTML=`<span>Envoyer</span>`;
  }
}

let isSubmitting=false;
let cooldownTimer=null;

form.addEventListener("submit", async e=>{
  e.preventDefault();
  if(isSubmitting) return;
  if(!form.reportValidity()) return;

  const prenom=document.getElementById("prenom").value.trim();
  const nom=document.getElementById("nom").value.trim();
  const email=document.getElementById("email").value.trim();
  const participation=document.getElementById("participation").value;
  const nb_personnes=document.getElementById("nb_personnes").value;
  const hp=(document.getElementById("hp")?.value||"").trim();

  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    showMessage("Adresse mail invalide.","err"); return;
  }
  if(!prenom||!nom||!email||!participation||!nb_personnes){
    showMessage("Veuillez remplir tous les champs !","err"); return;
  }
  if(hp){ showMessage("Merci !","ok"); return; }

  isSubmitting=true; setLoading(true); result.classList.remove("show");
  const params=new URLSearchParams(new FormData(form));

  try{
    const res=await fetch(SHEET_URL,{method:"POST",body:params});
    const text=await res.text();

    if(res.ok && /^OK/i.test(text)){
      if(participation==="oui"){
        showMessage(`Merci ${prenom} ${nom}, on se réjouit de ta présence ! 🎊`,"ok");
        launchConfetti();
      } else {
        showMessage(`Dommage ${prenom} ${nom}, peut-être une prochaine fois 😢`,"warn");
      }

      form.reset();
      fields.forEach(id=>localStorage.removeItem(id));

      if(LOCK_AFTER_SUCCESS){
        submitBtn.disabled=true;
        submitBtn.innerHTML=`<span>✔ Envoyé</span>`;
        submitBtn.style.backgroundColor="#999";
        submitBtn.style.cursor="not-allowed";
      } else startCooldown();

    } else {
      showMessage(`Erreur lors de l'envoi. ${text}`,"err");
      startCooldown();
    }

  } catch(err){
    showMessage("Erreur lors de l'envoi. Vérifiez votre connexion.","err");
    console.error(err);
    startCooldown();
  } finally{
    isSubmitting=false; setLoading(false);
  }
});

function startCooldown(){
  let remaining=ANTISPAM_DELAY;
  submitBtn.disabled=true;
  submitBtn.innerHTML=`⏳ Attendez ${remaining}s`;
  cooldownTimer=setInterval(()=>{
    remaining--;
    if(remaining>0) submitBtn.innerHTML=`⏳ Attendez ${remaining}s`;
    else{
      clearInterval(cooldownTimer);
      submitBtn.disabled=false;
      submitBtn.innerHTML=`<span>Envoyer</span>`;
    }
  },1000);
}
</script>

</body>
</html>
