<script>
const form = document.getElementById("invitationForm");
const result = document.getElementById("result");
const loader = document.getElementById("loader");
const submitBtn = form.querySelector("button[type='submit']");
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwQZAC1BrnLyndTvt1AlSERvATWI5hYwW4dFZAzfx2O39A8yrKWKRy06Qi5EUSrYf3R4Q/exec"; // Remplace par ton URL Google Apps Script

// === Sauvegarde locale ===
const fields = ["prenom", "nom", "email", "participation"];

// Charger les donnÃ©es sauvegardÃ©es
window.addEventListener("DOMContentLoaded", () => {
  fields.forEach(id => {
    const saved = localStorage.getItem(id);
    if(saved) document.getElementById(id).value = saved;
  });
});

// Sauvegarder Ã  chaque modification
fields.forEach(id => {
  document.getElementById(id).addEventListener("input", e => {
    localStorage.setItem(id, e.target.value);
  });
});

let lastConfetti = 0;
function launchConfetti(){
  const now = Date.now();
  if(now - lastConfetti < 1000) return; // max 1 tir/s
  lastConfetti = now;
  
  for(let i=0;i<50;i++){
    const confetti = document.createElement("div");
    confetti.classList.add("confetti");
    confetti.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
    confetti.style.left = Math.random()*100 + "vw";
    confetti.style.animationDuration = (2 + Math.random()*2) + "s";
    confetti.style.width = confetti.style.height = (5 + Math.random()*10) + "px";
    document.body.appendChild(confetti);
    setTimeout(()=>{ confetti.remove(); }, 3000);
  }
}

form.addEventListener("submit", function(e){
  e.preventDefault();
  const prenom = document.getElementById("prenom").value.trim();
  const nom = document.getElementById("nom").value.trim();
  const email = document.getElementById("email").value.trim();
  const participation = document.getElementById("participation").value;

  // Validation email regex
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailPattern.test(email)){
    result.textContent = "Adresse mail invalide.";
    result.style.color = "red";
    result.classList.add("show");
    result.style.animation = "shake 0.5s";
    return;
  }

  if(!prenom || !nom || !email || !participation){
    result.textContent = "Veuillez remplir tous les champs !";
    result.style.color = "red";
    result.classList.add("show");
    result.style.animation = "shake 0.5s";
    return;
  }

  loader.style.display = "block"; 
  submitBtn.disabled = true;      
  submitBtn.textContent = "Envoi..."; 
  result.classList.remove("show");

  fetch(SHEET_URL, {
    method: "POST",
    body: new URLSearchParams({ prenom, nom, email, participation })
  })
  .then(res => res.text())
  .then(data => {
    if(participation === "oui"){
      result.textContent = `Merci ${prenom} ${nom}, on se rÃ©jouit de ta prÃ©sence ! ðŸŽŠ`;
      result.style.color = "green";
      launchConfetti();
    } else {
      result.textContent = `Dommage ${prenom} ${nom}, peut-Ãªtre une prochaine fois ðŸ˜¢`;
      result.style.color = "orange";
    }
    result.classList.add("show");
    result.style.animation = "";

    form.reset();
    fields.forEach(id => localStorage.removeItem(id));

    // Bouton reste dÃ©sactivÃ©
    submitBtn.textContent = "âœ” EnvoyÃ©";
    submitBtn.style.backgroundColor = "#999"; // gris
    submitBtn.style.cursor = "not-allowed";
  })
  .catch(err => {
    result.textContent = "Erreur lors de l'envoi. RÃ©essaie plus tard.";
    result.style.color = "red";
    result.classList.add("show");
    result.style.animation = "shake 0.5s";
    console.error(err);

    // RÃ©activer le bouton si erreur
    submitBtn.disabled = false;
    submitBtn.textContent = "Envoyer";
    submitBtn.style.backgroundColor = ""; 
    submitBtn.style.cursor = "pointer";
  })
  .finally(() => {
    loader.style.display = "none"; 
  });
});
</script>
